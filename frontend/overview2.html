<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - STEADYMONITOR</title>
    <link rel="stylesheet" href="css/base.css">
    <style>
        .page-overview {
            --overview-grid-gap: 1.5rem;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--overview-grid-gap);
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-gradient);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-primary);
            margin: 0.5rem 0;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .trend-up {
            color: var(--color-success);
        }

        .trend-down {
            color: var(--color-danger);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--overview-grid-gap);
            margin-bottom: 2rem;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            text-align: left;
            padding: 1rem;
            background: var(--color-surface);
            border-bottom: 2px solid var(--color-border);
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: var(--color-surface-hover);
        }

        .currency {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-success {
            background: var(--color-success-light);
            color: var(--color-success-dark);
        }

        .badge-warning {
            background: var(--color-warning-light);
            color: var(--color-warning-dark);
        }

        .badge-info {
            background: var(--color-info-light);
            color: var(--color-info-dark);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--color-text-tertiary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--color-text-tertiary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .overview-grid {
                grid-template-columns: 1fr;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <aside class="sidebar">
            <nav class="sidebar-nav"></nav>
        </aside>

        <div class="main-content-wrapper">
            <header class="top-nav">
                <button class="menu-toggle">‚ò∞</button>
                <div class="nav-brand">STEADYMONITOR</div>
                <div class="nav-user">
                    <span class="user-greeting"></span>
                    <div class="dropdown"></div>
                </div>
            </header>

            <main class="main-content">
                <div class="page-overview">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Dashboard Overview</h3>
                        </div>
                        <div class="card-body">
                            <div class="overview-grid" id="statsGrid">
                                <!-- Stats cards will be loaded here -->
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    <p>Loading dashboard statistics...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="data-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Low Stock Products</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="data-table" id="lowStockTable">
                                        <thead>
                                            <tr>
                                                <th>Product ID</th>
                                                <th>Name</th>
                                                <th>Stock Qty</th>
                                                <th>Reorder Level</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Low stock data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="empty-state" id="lowStockEmpty" style="display: none;">
                                    <div class="empty-state-icon">üì¶</div>
                                    <p>No low stock products found</p>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Recent Sales</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="data-table" id="recentSalesTable">
                                        <thead>
                                            <tr>
                                                <th>Invoice</th>
                                                <th>Total</th>
                                                <th>Date</th>
                                                <th>Served By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Recent sales data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="empty-state" id="recentSalesEmpty" style="display: none;">
                                    <div class="empty-state-icon">üí∞</div>
                                    <p>No recent sales found</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Customers with Outstanding Balance</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table" id="customersBalanceTable">
                                    <thead>
                                        <tr>
                                            <th>Customer ID</th>
                                            <th>Name</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Customers balance data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="empty-state" id="customersBalanceEmpty" style="display: none;">
                                <div class="empty-state-icon">üë•</div>
                                <p>No customers with outstanding balance</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="sidebar-overlay"></div>

    <script src="js/auth.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/api.js"></script>
    <script>
                    // Auth check
                    document.addEventListener('DOMContentLoaded', async function() {
                        if (window.auth) {
                            const authenticated = await window.auth.requireAuth();
                            if (!authenticated) return;
                        }
                    });
                
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!window.auth || !window.auth.checkAuth()) {
                window.location.href = 'login.html';
                return;
            }

            const user = window.auth.getUser();
            document.querySelector('.user-greeting').textContent = `Welcome, ${user.displayName || user.username}`;

            // Load all dashboard data
            await Promise.all([
                loadDashboardStats(),
                loadLowStockProducts(),
                loadRecentSales(),
                loadCustomersBalance()
            ]);
        });

        async function loadDashboardStats() {
            try {
                const data = await window.api.get('https://steadymonitor-backend.onrender.com/api/dashboard/stats');
                
                if (data.success) {
                    const stats = data.stats;
                    const statsGrid = document.getElementById('statsGrid');
                    
                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-label">Total Products</div>
                            <div class="stat-value">${stats.products.toLocaleString()}</div>
                            <div class="stat-trend">
                                <span class="trend-up">üì¶ Active inventory</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-label">Total Customers</div>
                            <div class="stat-value">${stats.customers.toLocaleString()}</div>
                            <div class="stat-trend">
                                <span class="trend-up">üë• Registered learners</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-label">Today's Sales</div>
                            <div class="stat-value">
                                <span class="currency">KES ${stats.todaySales.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                            <div class="stat-trend">
                                <span class="${stats.todaySales.count > 0 ? 'trend-up' : 'trend-down'}">
                                    ${stats.todaySales.count} transaction${stats.todaySales.count !== 1 ? 's' : ''}
                                </span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-label">Low Stock Items</div>
                            <div class="stat-value">${stats.lowStock.toLocaleString()}</div>
                            <div class="stat-trend">
                                <span class="${stats.lowStock > 0 ? 'trend-down' : 'trend-up'}">
                                    ${stats.lowStock > 0 ? 'Needs attention' : 'All good'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-label">Stock Value</div>
                            <div class="stat-value">
                                <span class="currency">KES ${stats.stockValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                            <div class="stat-trend">
                                <span class="trend-up">Total inventory value</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-label">Average Sale</div>
                            <div class="stat-value">
                                <span class="currency">
                                    ${stats.todaySales.count > 0 
                                        ? 'KES ' + (stats.todaySales.total / stats.todaySales.count).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                                        : 'KES 0.00'}
                                </span>
                            </div>
                            <div class="stat-trend">
                                <span class="${stats.todaySales.total > 0 ? 'trend-up' : 'trend-down'}">
                                    ${stats.todaySales.count > 0 ? 'Per transaction' : 'No sales today'}
                                </span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                document.getElementById('statsGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>Failed to load dashboard statistics</p>
                        <button onclick="loadDashboardStats()" class="btn btn-primary">Retry</button>
                    </div>
                `;
            }
        }

        async function loadLowStockProducts() {
            try {
                const data = await window.api.get('https://steadymonitor-backend.onrender.com/api/dashboard/low-stock');
                
                if (data.success) {
                    const tableBody = document.querySelector('#lowStockTable tbody');
                    const emptyState = document.getElementById('lowStockEmpty');
                    
                    if (data.products && data.products.length > 0) {
                        tableBody.innerHTML = data.products.map(product => `
                            <tr>
                                <td>${product.product_id}</td>
                                <td>${product.name}</td>
                                <td>
                                    <span class="badge ${product.stock_qty === 0 ? 'badge-danger' : 'badge-warning'}">
                                        ${product.stock_qty}
                                    </span>
                                </td>
                                <td>${product.reorder_level}</td>
                            </tr>
                        `).join('');
                        emptyState.style.display = 'none';
                    } else {
                        tableBody.innerHTML = '';
                        emptyState.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading low stock products:', error);
                document.getElementById('lowStockEmpty').innerHTML = `
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <p>Failed to load low stock products</p>
                    <button onclick="loadLowStockProducts()" class="btn btn-primary">Retry</button>
                `;
                document.getElementById('lowStockEmpty').style.display = 'block';
            }
        }

        async function loadRecentSales() {
            try {
                const data = await window.api.get('https://steadymonitor-backend.onrender.com/api/dashboard/recent-sales');
                
                if (data.success) {
                    const tableBody = document.querySelector('#recentSalesTable tbody');
                    const emptyState = document.getElementById('recentSalesEmpty');
                    
                    if (data.sales && data.sales.length > 0) {
                        tableBody.innerHTML = data.sales.map(sale => `
                            <tr>
                                <td>${sale.invoice_number || 'N/A'}</td>
                                <td>
                                    <span class="currency">
                                        KES ${parseFloat(sale.total).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                    </span>
                                </td>
                                <td>${new Date(sale.date).toLocaleDateString()}</td>
                                <td>${sale.served_by || 'System'}</td>
                            </tr>
                        `).join('');
                        emptyState.style.display = 'none';
                    } else {
                        tableBody.innerHTML = '';
                        emptyState.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading recent sales:', error);
                document.getElementById('recentSalesEmpty').innerHTML = `
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <p>Failed to load recent sales</p>
                    <button onclick="loadRecentSales()" class="btn btn-primary">Retry</button>
                `;
                document.getElementById('recentSalesEmpty').style.display = 'block';
            }
        }

        async function loadCustomersBalance() {
            try {
                const data = await window.api.get('https://steadymonitor-backend.onrender.com/api/dashboard/customers-balance');
                
                if (data.success) {
                    const tableBody = document.querySelector('#customersBalanceTable tbody');
                    const emptyState = document.getElementById('customersBalanceEmpty');
                    
                    if (data.customers && data.customers.length > 0) {
                        tableBody.innerHTML = data.customers.map(customer => `
                            <tr>
                                <td>${customer.customer_id}</td>
                                <td>${customer.name}</td>
                                <td>
                                    <span class="currency badge badge-warning">
                                        KES ${parseFloat(customer.balance).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                    </span>
                                </td>
                            </tr>
                        `).join('');
                        emptyState.style.display = 'none';
                    } else {
                        tableBody.innerHTML = '';
                        emptyState.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading customers with balance:', error);
                document.getElementById('customersBalanceEmpty').innerHTML = `
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <p>Failed to load customers with balance</p>
                    <button onclick="loadCustomersBalance()" class="btn btn-primary">Retry</button>
                `;
                document.getElementById('customersBalanceEmpty').style.display = 'block';
            }
        }

        // Auto-refresh dashboard every 5 minutes
        setInterval(() => {
            loadDashboardStats();
        }, 300000);
    </script>
</body>
</html>