<!DOCTYPE html>
<html>
<head>
    <title>API & Auth Test</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { margin: 5px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 4px; overflow: auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        h2 { color: #333; }
    </style>
</head>
<body>
    <h1>SteadyMonitor API & Auth Test</h1>
    
    <div class="test-section">
        <h2>1. API Connection Test</h2>
        <button onclick="testAPI()">Test API Connection</button>
        <button onclick="testAllEndpoints()">Test All Endpoints</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Auth Test</h2>
        <div id="authStatus">Checking auth status...</div>
        <button onclick="checkAuth()">Check Auth Status</button>
        <button onclick="gotoLogin()">Go to Login Page</button>
    </div>
    
    <div class="test-section">
        <h2>3. Role-Based Redirect Test</h2>
        <p>Current user role: <span id="currentRole">Not logged in</span></p>
        <p>Expected redirect based on role:</p>
        <ul>
            <li>admin → admin.html</li>
            <li>department_uniform → department.html</li>
            <li>department_stationery → department.html</li>
            <li>other → pos.html</li>
        </ul>
        <button onclick="testRedirect()">Test Redirect Logic</button>
    </div>
    
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        // Wait for auth to initialize
        setTimeout(() => {
            updateAuthStatus();
        }, 500);
        
        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'Testing API connection...';
            
            try {
                const response = await API.call('https://steadymonitor-backend.onrender.com/api/auth/check');
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>✓ API Connection Successful</h3>
                        <p>Status: ${response.success ? 'OK' : 'Failed'}</p>
                        <p>Authenticated: ${response.isAuthenticated ? 'Yes' : 'No'}</p>
                        <pre>${JSON.stringify(response, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>✗ API Connection Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testAllEndpoints() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<h3>Testing all endpoints...</h3>';
            
            const endpoints = [
                { name: 'Auth Check', url: 'https://steadymonitor-backend.onrender.com/api/auth/check' },
                { name: 'Customers', url: 'https://steadymonitor-backend.onrender.com/api/customers' },
                { name: 'Products', url: 'https://steadymonitor-backend.onrender.com/api/inventory/products' },
                { name: 'Dashboard', url: 'https://steadymonitor-backend.onrender.com/api/dashboard/stats' },
                { name: 'Departments', url: 'https://steadymonitor-backend.onrender.com/api/pos/departments' }
            ];
            
            for (const endpoint of endpoints) {
                const div = document.createElement('div');
                div.innerHTML = `Testing ${endpoint.name}...`;
                resultDiv.appendChild(div);
                
                try {
                    await API.call(endpoint.url);
                    div.innerHTML = `<span class="success">✓ ${endpoint.name}</span>`;
                } catch (error) {
                    div.innerHTML = `<span class="error">✗ ${endpoint.name} - ${error.message}</span>`;
                }
            }
        }
        
        function updateAuthStatus() {
            const authDiv = document.getElementById('authStatus');
            const roleSpan = document.getElementById('currentRole');
            
            if (window.auth && window.auth.user) {
                const user = window.auth.user;
                authDiv.innerHTML = `
                    <div class="success">
                        <h3>✓ Authenticated</h3>
                        <p>User: ${user.username}</p>
                        <p>Role: ${user.role}</p>
                        <p>Name: ${user.display_name || user.username}</p>
                    </div>
                `;
                roleSpan.textContent = user.role;
            } else {
                authDiv.innerHTML = `
                    <div class="error">
                        <h3>✗ Not Authenticated</h3>
                        <p>Please login to access the system</p>
                    </div>
                `;
                roleSpan.textContent = 'Not logged in';
            }
        }
        
        function checkAuth() {
            if (window.auth) {
                window.auth.init().then(() => {
                    updateAuthStatus();
                });
            }
        }
        
        function gotoLogin() {
            window.location.href = '/login.html';
        }
        
        function testRedirect() {
            if (window.auth && window.auth.user) {
                window.auth.redirectByRole(window.auth.user);
            } else {
                alert('Not logged in. Redirecting to login page.');
                window.location.href = '/login.html';
            }
        }
    </script>
</body>
</html>