<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteadyMonitor - Reports</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Base CSS -->
    <link rel="stylesheet" href="css/base.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Date Range Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <script src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    
    <style>
        /* Reports specific styles */
        .report-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }
        
        .report-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--background);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .report-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .report-content {
            padding: var(--spacing-lg);
        }
        
        .stat-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .stat-change {
            font-size: var(--font-size-xs);
            padding: 2px 6px;
            border-radius: var(--border-radius-sm);
        }
        
        .stat-change.positive {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success);
        }
        
        .stat-change.negative {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }
        
        .filters-container {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--background);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            min-width: 200px;
        }
        
        .filter-label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: var(--spacing-md) 0;
        }
        
        .export-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--spacing-md) 0;
        }
        
        .data-table th {
            background: var(--background);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        
        .data-table tbody tr:hover {
            background-color: rgba(37, 99, 235, 0.02);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .date-range-display {
            background: var(--background);
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-2xl);
            color: var(--text-muted);
        }
        
        .loading-indicator i {
            font-size: 2rem;
            margin-right: var(--spacing-md);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .filters-container {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .report-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .export-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="main-content-wrapper">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <button id="menuToggle" class="menu-toggle mobile-show">
                <i class="fas fa-bars"></i>
            </button>
            <a href="#" class="nav-brand">
                <i class="fas fa-chart-bar"></i>
                <span>SteadyMonitor</span>
            </a>
            <div class="nav-user">
                <span class="user-greeting" id="userGreeting">Welcome</span>
                <div class="dropdown">
                    <button class="btn btn-outline btn-sm dropdown-toggle" id="userMenu">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <div class="dropdown-menu" id="userDropdown">
                        <a href="#" class="dropdown-item" id="profileLink">
                            <i class="fas fa-user"></i> Profile
                        </a>
                        <a href="#" class="dropdown-item" id="settingsLink">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item text-danger" id="logoutLink">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar Overlay (Mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Menu will be loaded by menu.js -->
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <div class="page-title">
                    <div>
                        <h1><i class="fas fa-chart-bar"></i> Reports Dashboard</h1>
                        <p class="text-muted">Comprehensive analytics and reporting</p>
                    </div>
                    <div class="date-range-display" id="dateRangeDisplay">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Last 30 days</span>
                    </div>
                </div>
            </header>

            <!-- Reports Tabs -->
            <div class="card">
                <div class="tabs-nav" id="reportTabs">
                    <button class="tab-btn active" data-tab="overview">
                        <i class="fas fa-chart-pie"></i> Overview
                    </button>
                    <button class="tab-btn" data-tab="sales">
                        <i class="fas fa-shopping-cart"></i> Sales
                    </button>
                    <button class="tab-btn" data-tab="inventory">
                        <i class="fas fa-boxes"></i> Inventory
                    </button>
                    <button class="tab-btn" data-tab="customers">
                        <i class="fas fa-users"></i> Customers
                    </button>
                    <button class="tab-btn" data-tab="allocations">
                        <i class="fas fa-gift"></i> Allocations
                    </button>
                    <button class="tab-btn" data-tab="pocket-money">
                        <i class="fas fa-wallet"></i> Pocket Money
                    </button>
                    <button class="tab-btn" data-tab="installments">
                        <i class="fas fa-credit-card"></i> Installments
                    </button>
                    <button class="tab-btn" data-tab="profit">
                        <i class="fas fa-money-bill-wave"></i> Profit
                    </button>
                </div>

                <!-- Date Range Picker -->
                <div class="filters-container">
                    <div class="filter-group">
                        <label class="filter-label">Date Range</label>
                        <input type="text" id="dateRangePicker" class="form-control" 
                               placeholder="Select date range">
                    </div>
                    <div class="filter-group" id="departmentFilterContainer">
                        <label class="filter-label">Department</label>
                        <select id="departmentFilter" class="form-control">
                            <option value="all">All Departments</option>
                            <option value="uniform">Uniform</option>
                            <option value="stationery">Stationery</option>
                            <option value="food">Food & Snacks</option>
                        </select>
                    </div>
                    <div class="filter-group" id="programFilterContainer">
                        <label class="filter-label">Program</label>
                        <select id="programFilter" class="form-control">
                            <option value="all">All Programs</option>
                            <option value="A">Program A</option>
                            <option value="B">Program B</option>
                            <option value="learner">Learners</option>
                            <option value="walkin">Walk-in</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">&nbsp;</label>
                        <button class="btn btn-primary" id="applyFilters">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <button class="btn btn-outline" id="resetFilters">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Content Sections -->
            <div id="reportContent">
                <!-- Overview Tab -->
                <div class="tab-pane active" id="overview-tab">
                    <!-- Summary Stats -->
                    <div class="summary-grid" id="overviewStats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalSales">₵0.00</div>
                            <div class="stat-label">Total Sales</div>
                            <div class="stat-change positive" id="salesChange">+0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalCustomers">0</div>
                            <div class="stat-label">Active Customers</div>
                            <div class="stat-change positive" id="customersChange">+0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="profitMargin">0%</div>
                            <div class="stat-label">Profit Margin</div>
                            <div class="stat-change" id="marginChange">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="lowStockItems">0</div>
                            <div class="stat-label">Low Stock Items</div>
                            <div class="stat-change negative" id="stockChange">0</div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-2">
                        <div class="chart-card">
                            <h4>Sales Trend</h4>
                            <div class="chart-container">
                                <canvas id="salesTrendChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Department Distribution</h4>
                            <div class="chart-container">
                                <canvas id="departmentChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Payment Methods</h4>
                            <div class="chart-container">
                                <canvas id="paymentMethodChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Customer Types</h4>
                            <div class="chart-container">
                                <canvas id="customerTypeChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="report-section">
                        <div class="report-header">
                            <h3 class="report-title"><i class="fas fa-history"></i> Recent Activity</h3>
                        </div>
                        <div class="report-content">
                            <div class="table-container">
                                <table class="table" id="recentActivityTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Customer</th>
                                            <th>Amount</th>
                                            <th>Department</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales Tab -->
                <div class="tab-pane" id="sales-tab">
                    <div class="report-section">
                        <div class="report-header">
                            <h3 class="report-title"><i class="fas fa-shopping-cart"></i> Sales Report</h3>
                            <div class="export-buttons">
                                <button class="btn btn-outline btn-sm" id="exportSalesExcel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn btn-outline btn-sm" id="exportSalesPDF">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div class="report-content">
                            <div class="loading-indicator" id="salesLoading">
                                <i class="fas fa-spinner"></i> Loading sales data...
                            </div>
                            <div id="salesContent" style="display: none;">
                                <!-- Sales summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div class="tab-pane" id="inventory-tab">
                    <div class="report-section">
                        <div class="report-header">
                            <h3 class="report-title"><i class="fas fa-boxes"></i> Inventory Report</h3>
                            <div class="export-buttons">
                                <button class="btn btn-outline btn-sm" id="exportInventoryExcel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                        <div class="report-content">
                            <div class="loading-indicator" id="inventoryLoading">
                                <i class="fas fa-spinner"></i> Loading inventory data...
                            </div>
                            <div id="inventoryContent" style="display: none;">
                                <!-- Inventory summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customers Tab -->
                <div class="tab-pane" id="customers-tab">
                    <div class="report-section">
                        <div class="report-header">
                            <h3 class="report-title"><i class="fas fa-users"></i> Customer Report</h3>
                            <div class="export-buttons">
                                <button class="btn btn-outline btn-sm" id="exportCustomersExcel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                        <div class="report-content">
                            <div class="loading-indicator" id="customersLoading">
                                <i class="fas fa-spinner"></i> Loading customer data...
                            </div>
                            <div id="customersContent" style="display: none;">
                                <!-- Customer summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Allocations Tab -->
                <div class="tab-pane" id="allocations-tab">
                    <div class="report-section">
                        <div class="report-header">
                            <h3 class="report-title"><i class="fas fa-gift"></i> Allocation Report</h3>
                        </div>
                        <div class="report-content">
                            <div class="loading-indicator" id="allocationsLoading">
                                <i class="fas fa-spinner"></i> Loading allocation data...
                            </div>
                            <div id="allocationsContent" style="display: none;">
                                <!-- Allocation summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pocket Money Tab -->
                <div class="tab-pane" id="pocket-money-tab">
                    <div class="report-section">
                        <div class="report-header">
                            <h3 class="report-title"><i class="fas fa-wallet"></i> Pocket Money Report</h3>
                        </div>
                        <div class="report-content">
                            <div class="loading-indicator" id="pocketMoneyLoading">
                                <i class="fas fa-spinner"></i> Loading pocket money data...
                            </div>
                            <div id="pocketMoneyContent" style="display: none;">
                                <!-- Pocket money summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Installments Tab -->
                <div class="tab-pane" id="installments-tab">
                    <div class="report-section">
                        <div class="report-header">
                            <h3 class="report-title"><i class="fas fa-credit-card"></i> Installment Report</h3>
                        </div>
                        <div class="report-content">
                            <div class="loading-indicator" id="installmentsLoading">
                                <i class="fas fa-spinner"></i> Loading installment data...
                            </div>
                            <div id="installmentsContent" style="display: none;">
                                <!-- Installment summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profit Tab -->
                <div class="tab-pane" id="profit-tab">
                    <div class="report-section">
                        <div class="report-header">
                            <h3 class="report-title"><i class="fas fa-money-bill-wave"></i> Profit Report</h3>
                            <div class="export-buttons">
                                <button class="btn btn-outline btn-sm" id="exportProfitExcel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn btn-outline btn-sm" id="exportProfitPDF">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div class="report-content">
                            <div class="loading-indicator" id="profitLoading">
                                <i class="fas fa-spinner"></i> Loading profit data...
                            </div>
                            <div id="profitContent" style="display: none;">
                                <!-- Profit summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Files -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/menu.js"></script>
    
    <script>
        // Reports Manager
        class ReportsManager {
            constructor() {
                this.currentTab = 'overview';
                this.filters = {
                    start_date: null,
                    end_date: null,
                    department: 'all',
                    program_type: 'all'
                };
                this.charts = {};
                this.init();
            }

            async init() {
                // Wait for auth to be ready
                await this.waitForAuth();
                
                // Initialize date range picker
                this.initDateRangePicker();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Load initial data
                this.loadOverviewData();
                
                console.log('Reports manager initialized');
            }

            async waitForAuth() {
                return new Promise((resolve) => {
                    if (window.auth && window.auth.getUser()) {
                        resolve();
                        return;
                    }

                    let attempts = 0;
                    const maxAttempts = 10;
                    
                    const checkAuth = setInterval(() => {
                        attempts++;
                        if (window.auth && window.auth.getUser()) {
                            clearInterval(checkAuth);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            clearInterval(checkAuth);
                            resolve();
                        }
                    }, 100);
                });
            }

            initDateRangePicker() {
                const today = new Date();
                const lastMonth = new Date();
                lastMonth.setMonth(today.getMonth() - 1);

                $('#dateRangePicker').daterangepicker({
                    startDate: lastMonth,
                    endDate: today,
                    ranges: {
                        'Today': [moment(), moment()],
                        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                        'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                        'This Month': [moment().startOf('month'), moment().endOf('month')],
                        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    }
                }, (start, end, label) => {
                    this.filters.start_date = start.format('YYYY-MM-DD');
                    this.filters.end_date = end.format('YYYY-MM-DD');
                    
                    // Update display
                    const display = $('#dateRangeDisplay');
                    display.html(`<i class="fas fa-calendar-alt"></i> ${label}`);
                    
                    // Reload current tab data
                    this.loadTabData(this.currentTab);
                });

                // Set initial dates
                this.filters.start_date = lastMonth.toISOString().split('T')[0];
                this.filters.end_date = today.toISOString().split('T')[0];
            }

            setupEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.target.dataset.tab || e.target.closest('.tab-btn').dataset.tab;
                        this.switchTab(tab);
                    });
                });

                // Filter controls
                document.getElementById('applyFilters').addEventListener('click', () => {
                    this.filters.department = document.getElementById('departmentFilter').value;
                    this.filters.program_type = document.getElementById('programFilter').value;
                    this.loadTabData(this.currentTab);
                });

                document.getElementById('resetFilters').addEventListener('click', () => {
                    document.getElementById('departmentFilter').value = 'all';
                    document.getElementById('programFilter').value = 'all';
                    
                    // Reset date range to last 30 days
                    const today = new Date();
                    const lastMonth = new Date();
                    lastMonth.setMonth(today.getMonth() - 1);
                    
                    $('#dateRangePicker').data('daterangepicker').setStartDate(lastMonth);
                    $('#dateRangePicker').data('daterangepicker').setEndDate(today);
                    
                    this.filters = {
                        start_date: lastMonth.toISOString().split('T')[0],
                        end_date: today.toISOString().split('T')[0],
                        department: 'all',
                        program_type: 'all'
                    };
                    
                    document.getElementById('dateRangeDisplay').innerHTML = 
                        '<i class="fas fa-calendar-alt"></i> Last 30 days';
                    
                    this.loadTabData(this.currentTab);
                });

                // Export buttons
                document.getElementById('exportSalesExcel')?.addEventListener('click', () => this.exportReport('sales', 'excel'));
                document.getElementById('exportSalesPDF')?.addEventListener('click', () => this.exportReport('sales', 'pdf'));
                document.getElementById('exportInventoryExcel')?.addEventListener('click', () => this.exportReport('inventory', 'excel'));
                document.getElementById('exportCustomersExcel')?.addEventListener('click', () => this.exportReport('customers', 'excel'));
                document.getElementById('exportProfitExcel')?.addEventListener('click', () => this.exportReport('profit', 'excel'));
                document.getElementById('exportProfitPDF')?.addEventListener('click', () => this.exportReport('profit', 'pdf'));

                // User menu
                document.getElementById('logoutLink')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleLogout();
                });
            }

            switchTab(tabName) {
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update active tab content
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');

                this.currentTab = tabName;
                this.loadTabData(tabName);
            }

            async loadTabData(tabName) {
                console.log(`Loading ${tabName} data...`);
                
                switch(tabName) {
                    case 'overview':
                        await this.loadOverviewData();
                        break;
                    case 'sales':
                        await this.loadSalesReport();
                        break;
                    case 'inventory':
                        await this.loadInventoryReport();
                        break;
                    case 'customers':
                        await this.loadCustomerReport();
                        break;
                    case 'allocations':
                        await this.loadAllocationReport();
                        break;
                    case 'pocket-money':
                        await this.loadPocketMoneyReport();
                        break;
                    case 'installments':
                        await this.loadInstallmentReport();
                        break;
                    case 'profit':
                        await this.loadProfitReport();
                        break;
                }
            }

            async loadOverviewData() {
                try {
                    // Show loading
                    this.showLoading('overview');
                    
                    // Get system overview
                    const response = await apiCall('https://steadymonitor-backend.onrender.com/api/reports/overview');
                    
                    if (response.success) {
                        this.updateOverviewStats(response);
                        this.updateRecentActivity(response);
                    }
                    
                    // Get sales report for charts
                    const salesResponse = await apiCall(`https://steadymonitor-backend.onrender.com/api/reports/sales?start_date=${this.filters.start_date}&end_date=${this.filters.end_date}`);
                    
                    if (salesResponse.success) {
                        this.createCharts(salesResponse);
                    }
                    
                    this.hideLoading('overview');
                    
                } catch (error) {
                    console.error('Error loading overview:', error);
                    this.showError('overview', 'Failed to load overview data');
                }
            }

            updateOverviewStats(data) {
                // Update summary cards
                if (data.today) {
                    document.getElementById('totalSales').textContent = 
                        `₵${parseFloat(data.today.sales_total || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                }
                
                if (data.counts) {
                    document.getElementById('totalCustomers').textContent = 
                        data.counts.customers.toLocaleString();
                    document.getElementById('lowStockItems').textContent = 
                        data.counts.low_stock_items.toLocaleString();
                }
                
                // You would calculate profit margin from other data
                // This is a placeholder - you should fetch actual profit data
                document.getElementById('profitMargin').textContent = '25%';
            }

            updateRecentActivity(data) {
                // This is a simplified version - you would fetch actual recent activity
                const tableBody = document.querySelector('#recentActivityTable tbody');
                tableBody.innerHTML = `
                    <tr>
                        <td>${new Date().toLocaleDateString()}</td>
                        <td><span class="badge badge-primary">Sale</span></td>
                        <td>John Doe</td>
                        <td>₵150.00</td>
                        <td>Uniform</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                    <tr>
                        <td>${new Date().toLocaleDateString()}</td>
                        <td><span class="badge badge-warning">Allocation</span></td>
                        <td>Jane Smith</td>
                        <td>₵50.00</td>
                        <td>Stationery</td>
                        <td><span class="badge badge-success">Given</span></td>
                    </tr>
                `;
            }

            createCharts(salesData) {
                // Destroy existing charts
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};

                // Sales Trend Chart
                if (salesData.summary) {
                    const ctx1 = document.getElementById('salesTrendChart').getContext('2d');
                    this.charts.salesTrend = new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Sales (₵)',
                                data: [1200, 1900, 1500, 2000, 1800, 2200, 2100],
                                borderColor: '#2563EB',
                                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }

                // Department Distribution Chart
                if (salesData.breakdown?.by_department) {
                    const ctx2 = document.getElementById('departmentChart').getContext('2d');
                    const departments = Object.keys(salesData.breakdown.by_department);
                    const amounts = departments.map(dept => salesData.breakdown.by_department[dept].total);
                    
                    this.charts.department = new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: departments,
                            datasets: [{
                                data: amounts,
                                backgroundColor: [
                                    '#2563EB', '#0F172A', '#16A34A', '#F59E0B', '#DC2626'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }

                // Add more charts as needed...
            }

            async loadSalesReport() {
                try {
                    this.showLoading('sales');
                    
                    const params = new URLSearchParams({
                        start_date: this.filters.start_date,
                        end_date: this.filters.end_date,
                        department: this.filters.department,
                        program_type: this.filters.program_type
                    });
                    
                    const response = await apiCall(`https://steadymonitor-backend.onrender.com/api/reports/sales?${params}`);
                    
                    if (response.success) {
                        this.renderSalesReport(response);
                    } else {
                        throw new Error(response.message || 'Failed to load sales report');
                    }
                    
                    this.hideLoading('sales');
                    
                } catch (error) {
                    console.error('Error loading sales report:', error);
                    this.showError('sales', 'Failed to load sales report');
                }
            }

            renderSalesReport(data) {
                const container = document.getElementById('salesContent');
                container.innerHTML = `
                    <div class="summary-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.total_transactions}</div>
                            <div class="stat-label">Total Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.summary.total_sales || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Total Sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.summary.total_paid || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Total Paid</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.summary.total_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Outstanding Balance</div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sale ID</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Department</th>
                                    <th>Payment Mode</th>
                                    <th>Total</th>
                                    <th>Paid</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.sales.slice(0, 10).map(sale => `
                                    <tr>
                                        <td>${sale.sale_id.substring(0, 8)}...</td>
                                        <td>${new Date(sale.date).toLocaleDateString()}</td>
                                        <td>${sale.customer_name || 'Walk-in'}</td>
                                        <td>${sale.department}</td>
                                        <td><span class="badge badge-secondary">${sale.payment_mode}</span></td>
                                        <td>₵${parseFloat(sale.total).toFixed(2)}</td>
                                        <td>₵${parseFloat(sale.paid).toFixed(2)}</td>
                                        <td><span class="${parseFloat(sale.balance) > 0 ? 'text-danger' : 'text-success'}">₵${parseFloat(sale.balance).toFixed(2)}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${data.sales.length > 10 ? `
                        <div class="text-center mt-3">
                            <span class="text-muted">Showing 10 of ${data.sales.length} transactions</span>
                        </div>
                    ` : ''}
                `;
                
                container.style.display = 'block';
            }

            async loadInventoryReport() {
                try {
                    this.showLoading('inventory');
                    
                    const response = await apiCall('https://steadymonitor-backend.onrender.com/api/reports/inventory');
                    
                    if (response.success) {
                        this.renderInventoryReport(response);
                    }
                    
                    this.hideLoading('inventory');
                    
                } catch (error) {
                    console.error('Error loading inventory report:', error);
                    this.showError('inventory', 'Failed to load inventory report');
                }
            }

            renderInventoryReport(data) {
                const container = document.getElementById('inventoryContent');
                container.innerHTML = `
                    <div class="summary-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.total_products}</div>
                            <div class="stat-label">Total Products</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.summary.total_retail_value || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Retail Value</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.low_stock_items}</div>
                            <div class="stat-label">Low Stock Items</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.overall_margin}%</div>
                            <div class="stat-label">Avg Margin</div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4 mb-3">Low Stock Alerts</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>SKU</th>
                                    <th>Department</th>
                                    <th>Current Stock</th>
                                    <th>Reorder Level</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.low_stock_products.map(product => `
                                    <tr>
                                        <td>${product.name}</td>
                                        <td><code>${product.sku}</code></td>
                                        <td>${product.department}</td>
                                        <td><span class="text-danger">${product.current_stock}</span></td>
                                        <td>${product.reorder_level}</td>
                                        <td><span class="badge badge-danger">Reorder Needed</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.style.display = 'block';
            }

            async loadCustomerReport() {
                try {
                    this.showLoading('customers');
                    
                    const params = new URLSearchParams({
                        program: this.filters.program_type,
                        has_balance: 'yes'
                    });
                    
                    const response = await apiCall(`https://steadymonitor-backend.onrender.com/api/reports/customers?${params}`);
                    
                    if (response.success) {
                        this.renderCustomerReport(response);
                    }
                    
                    this.hideLoading('customers');
                    
                } catch (error) {
                    console.error('Error loading customer report:', error);
                    this.showError('customers', 'Failed to load customer report');
                }
            }

            renderCustomerReport(data) {
                const container = document.getElementById('customersContent');
                container.innerHTML = `
                    <div class="summary-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.statistics.total_customers}</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.statistics.financial_summary.total_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Total Balance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.statistics.financial_summary.customers_with_balance}</div>
                            <div class="stat-label">Customers with Balance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.statistics.allocation_summary.total_allocations}</div>
                            <div class="stat-label">Active Allocations</div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4 mb-3">Customers with Outstanding Balances</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Customer ID</th>
                                    <th>Name</th>
                                    <th>Class</th>
                                    <th>Program</th>
                                    <th>Balance</th>
                                    <th>Installment Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.customers.filter(c => parseFloat(c.balance) > 0).slice(0, 10).map(customer => `
                                    <tr>
                                        <td>${customer.customer_id.substring(0, 8)}...</td>
                                        <td>${customer.name}</td>
                                        <td>${customer.class}</td>
                                        <td><span class="badge badge-primary">${customer.program_membership || 'none'}</span></td>
                                        <td><span class="text-danger">₵${parseFloat(customer.balance).toFixed(2)}</span></td>
                                        <td><span class="badge ${customer.installment_status === 'paid' ? 'badge-success' : 'badge-warning'}">${customer.installment_status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.style.display = 'block';
            }

            async loadAllocationReport() {
                try {
                    this.showLoading('allocations');
                    
                    const params = new URLSearchParams({
                        start_date: this.filters.start_date,
                        end_date: this.filters.end_date,
                        status: 'active'
                    });
                    
                    const response = await apiCall(`https://steadymonitor-backend.onrender.com/api/reports/allocations?${params}`);
                    
                    if (response.success) {
                        this.renderAllocationReport(response);
                    }
                    
                    this.hideLoading('allocations');
                    
                } catch (error) {
                    console.error('Error loading allocation report:', error);
                    this.showError('allocations', 'Failed to load allocation report');
                }
            }

            renderAllocationReport(data) {
                const container = document.getElementById('allocationsContent');
                container.innerHTML = `
                    <div class="summary-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.total_active_allocations}</div>
                            <div class="stat-label">Active Allocations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.pending_allocations}</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.allocations_given}</div>
                            <div class="stat-label">Given This Period</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.unique_customers}</div>
                            <div class="stat-label">Unique Customers</div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4 mb-3">Pending Allocations</h4>
                    ${data.pending_allocations_list.length > 0 ? `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Product</th>
                                        <th>Frequency</th>
                                        <th>Last Given</th>
                                        <th>Next Due</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.pending_allocations_list.map(alloc => `
                                        <tr>
                                            <td>${alloc.customer_name}</td>
                                            <td>${alloc.product_name}</td>
                                            <td>${alloc.frequency}</td>
                                            <td>${alloc.last_given ? new Date(alloc.last_given).toLocaleDateString() : 'Never'}</td>
                                            <td>${alloc.next_due ? new Date(alloc.next_due).toLocaleDateString() : 'N/A'}</td>
                                            <td>
                                                <span class="badge ${alloc.days_overdue > 0 ? 'badge-danger' : 'badge-warning'}">
                                                    ${alloc.days_overdue > 0 ? `Overdue ${alloc.days_overdue}d` : 'Due'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <h3>No pending allocations</h3>
                            <p>All allocations are up to date</p>
                        </div>
                    `}
                `;
                
                container.style.display = 'block';
            }

            async loadPocketMoneyReport() {
                try {
                    this.showLoading('pocket-money');
                    
                    const params = new URLSearchParams({
                        start_date: this.filters.start_date,
                        end_date: this.filters.end_date
                    });
                    
                    const response = await apiCall(`https://steadymonitor-backend.onrender.com/api/reports/pocket-money?${params}`);
                    
                    if (response.success) {
                        this.renderPocketMoneyReport(response);
                    }
                    
                    this.hideLoading('pocket-money');
                    
                } catch (error) {
                    console.error('Error loading pocket money report:', error);
                    this.showError('pocket-money', 'Failed to load pocket money report');
                }
            }

            renderPocketMoneyReport(data) {
                const container = document.getElementById('pocketMoneyContent');
                container.innerHTML = `
                    <div class="summary-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.total_transactions}</div>
                            <div class="stat-label">Total Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.summary.total_amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Total Amount</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.unique_customers}</div>
                            <div class="stat-label">Unique Customers</div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4 mb-3">Current Balances</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Class</th>
                                    <th>Current Balance</th>
                                    <th>Last Transaction</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.current_balances.slice(0, 10).map(balance => `
                                    <tr>
                                        <td>${balance.name}</td>
                                        <td>${balance.class}</td>
                                        <td><span class="${balance.current_balance > 0 ? 'text-success' : 'text-danger'}">₵${parseFloat(balance.current_balance).toFixed(2)}</span></td>
                                        <td>${new Date().toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.style.display = 'block';
            }

            async loadInstallmentReport() {
                try {
                    this.showLoading('installments');
                    
                    const params = new URLSearchParams({
                        start_date: this.filters.start_date,
                        end_date: this.filters.end_date
                    });
                    
                    const response = await apiCall(`https://steadymonitor-backend.onrender.com/api/reports/installments?${params}`);
                    
                    if (response.success) {
                        this.renderInstallmentReport(response);
                    }
                    
                    this.hideLoading('installments');
                    
                } catch (error) {
                    console.error('Error loading installment report:', error);
                    this.showError('installments', 'Failed to load installment report');
                }
            }

            renderInstallmentReport(data) {
                const container = document.getElementById('installmentsContent');
                container.innerHTML = `
                    <div class="summary-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.total_payments}</div>
                            <div class="stat-label">Total Payments</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.summary.total_amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Total Amount</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.unique_customers}</div>
                            <div class="stat-label">Unique Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.unique_parents}</div>
                            <div class="stat-label">Parents</div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4 mb-3">Recent Payments</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Parent</th>
                                    <th>Method</th>
                                    <th>Amount</th>
                                    <th>Reference</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.recent_payments.map(payment => `
                                    <tr>
                                        <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
                                        <td>${payment.customer_name}</td>
                                        <td>${payment.parent_name || 'N/A'}</td>
                                        <td><span class="badge badge-secondary">${payment.payment_method}</span></td>
                                        <td>₵${parseFloat(payment.amount).toFixed(2)}</td>
                                        <td><code>${payment.reference || 'N/A'}</code></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.style.display = 'block';
            }

            async loadProfitReport() {
                try {
                    this.showLoading('profit');
                    
                    const params = new URLSearchParams({
                        start_date: this.filters.start_date,
                        end_date: this.filters.end_date
                    });
                    
                    const response = await apiCall(`https://steadymonitor-backend.onrender.com/api/reports/profit?${params}`);
                    
                    if (response.success) {
                        this.renderProfitReport(response);
                    }
                    
                    this.hideLoading('profit');
                    
                } catch (error) {
                    console.error('Error loading profit report:', error);
                    this.showError('profit', 'Failed to load profit report');
                }
            }

            renderProfitReport(data) {
                const container = document.getElementById('profitContent');
                container.innerHTML = `
                    <div class="summary-grid">
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.financial_summary.total_revenue || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.financial_summary.gross_profit || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Gross Profit</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.financial_summary.profit_margin_percent}%</div>
                            <div class="stat-label">Profit Margin</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">₵${parseFloat(data.financial_summary.net_impact || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Net Impact</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h4>Cost Breakdown</h4>
                        <div class="payment-details">
                            <div class="detail-row">
                                <span class="detail-label">Total Cost of Goods Sold</span>
                                <span class="detail-value">₵${parseFloat(data.financial_summary.total_cost || 0).toFixed(2)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Restocking Costs</span>
                                <span class="detail-value">₵${parseFloat(data.financial_summary.total_restock_cost || 0).toFixed(2)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Allocation Program Costs</span>
                                <span class="detail-value">₵${parseFloat(data.financial_summary.allocation_program_cost || 0).toFixed(2)}</span>
                            </div>
                            <div class="detail-row" style="border-top: 2px solid var(--border); font-weight: 600;">
                                <span class="detail-label">Total Costs</span>
                                <span class="detail-value">₵${parseFloat(
                                    (data.financial_summary.total_cost || 0) + 
                                    (data.financial_summary.total_restock_cost || 0) + 
                                    (data.financial_summary.allocation_program_cost || 0)
                                ).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                container.style.display = 'block';
            }

            async exportReport(type, format) {
                try {
                    const params = new URLSearchParams({
                        type: type,
                        start_date: this.filters.start_date,
                        end_date: this.filters.end_date,
                        department: this.filters.department
                    });
                    
                    const endpoint = format === 'excel' ? 
                        `https://steadymonitor-backend.onrender.com/api/reports/export/excel?${params}` :
                        `https://steadymonitor-backend.onrender.com/api/reports/export/pdf?${params}`;
                    
                    const response = await fetch(endpoint, {
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Export failed');
                    }
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `steadymonitor-${type}-report-${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                } catch (error) {
                    console.error('Export error:', error);
                    alert('Failed to export report');
                }
            }

            showLoading(tab) {
                const loadingElement = document.getElementById(`${tab}Loading`);
                const contentElement = document.getElementById(`${tab}Content`);
                
                if (loadingElement) {
                    loadingElement.style.display = 'flex';
                }
                
                if (contentElement) {
                    contentElement.style.display = 'none';
                }
            }

            hideLoading(tab) {
                const loadingElement = document.getElementById(`${tab}Loading`);
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }

            showError(tab, message) {
                const contentElement = document.getElementById(`${tab}Content`);
                if (contentElement) {
                    contentElement.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle text-danger"></i>
                            <h3>Error Loading Data</h3>
                            <p>${message}</p>
                            <button class="btn btn-primary mt-3" onclick="reportsManager.loadTabData('${tab}')">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                        </div>
                    `;
                    contentElement.style.display = 'block';
                }
                
                this.hideLoading(tab);
            }

            handleLogout() {
                if (confirm('Are you sure you want to logout?')) {
                    if (window.auth && typeof window.auth.logout === 'function') {
                        window.auth.logout()
                            .then(() => {
                                window.location.href = 'login.html';
                            })
                            .catch(() => {
                                window.location.href = 'login.html';
                            });
                    } else {
                        window.location.href = 'login.html';
                    }
                }
            }
        }

        // Initialize reports manager when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.reportsManager = new ReportsManager();
        });
    </script>
</body>
</html>