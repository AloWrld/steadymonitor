<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments Management - Hattyjohns Investments</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- API and Auth scripts MUST be loaded before menu.js -->
    <script src="api.js"></script>
    <script src="auth.js"></script>
    <script src="menu.js"></script>
    <style>
        /* CSS Variables */
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --text: #1e293b;
            --text-muted: #64748b;
            --background: #f8fafc;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --border-radius: 8px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
        }

        /* Top Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .nav-brand i {
            font-size: 24px;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-greeting {
            font-weight: 500;
            color: var(--text);
        }

        /* Menu Toggle Button - ADDED for mobile */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text);
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .menu-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 64px;
            left: 0;
            bottom: 0;
            width: 250px;
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 99;
        }

        .sidebar-nav {
            padding: 16px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: var(--text);
            text-decoration: none;
            gap: 12px;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item.logout-item {
            color: var(--danger);
        }

        .nav-item.logout-item:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .nav-divider {
            height: 1px;
            background: var(--border);
            margin: 16px 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 98;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            margin-top: 64px;
            padding: 24px;
            min-height: calc(100vh - 64px);
        }

        /* Page Header */
        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .page-title h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title h1 i {
            color: var(--primary);
        }

        .text-muted {
            color: var(--text-muted);
        }

        /* Tabs */
        .tabs-nav {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 24px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: var(--primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            position: relative;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .card-body {
            padding: 24px;
        }

        /* Summary Stats */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            padding: 20px;
        }

        .summary-card h4 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .summary-card h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .summary-card p {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            padding: 20px;
        }

        .chart-card h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .table tr:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border-color: var(--border);
        }

        .btn-outline:hover {
            background: rgba(37, 99, 235, 0.1);
            border-color: var(--primary);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-icon {
            padding: 10px;
            width: 40px;
            height: 40px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-text {
            margin-top: 6px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .search-box {
            display: flex;
            gap: 8px;
        }

        .search-box .form-control {
            flex: 1;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 24px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Text Colors */
        .text-success {
            color: var(--success);
        }

        .text-danger {
            color: var(--danger);
        }

        .text-warning {
            color: var(--warning);
        }

        .text-primary {
            color: var(--primary);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Utilities */
        .text-center {
            text-align: center;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .date-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
            max-width: 400px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        
        .toast-success {
            border-left-color: var(--success);
        }
        
        .toast-error {
            border-left-color: var(--danger);
        }
        
        .toast-warning {
            border-left-color: var(--warning);
        }
        
        .toast-info {
            border-left-color: var(--primary);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* File upload */
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .file-upload input[type="file"] {
            padding: 8px;
            border: 2px dashed var(--border);
            border-radius: var(--border-radius);
        }
        
        /* Form check */
        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        
        .form-check-input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .form-check-label {
            cursor: pointer;
            user-select: none;
        }
        
        /* Scrollbar styling */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Loading spinner */
        .fa-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Learner Header */
        .learner-header {
            background: rgba(37, 99, 235, 0.05);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 20px;
        }

        .learner-header h4 {
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .totals {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .total-item {
            display: flex;
            flex-direction: column;
        }

        .total-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .total-value {
            font-size: 16px;
            font-weight: 600;
        }

        /* Preview Table */
        .preview-table {
            max-height: 300px;
            margin: 16px 0;
        }

        /* Upload Instructions */
        .upload-instructions {
            background: rgba(37, 99, 235, 0.05);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 20px;
        }

        .upload-instructions h5 {
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .upload-instructions ul {
            padding-left: 20px;
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .page-title {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-group {
                justify-content: flex-start;
            }
            
            .filter-controls {
                flex-wrap: wrap;
            }
            
            .modal {
                width: 95%;
                margin: 10px;
            }
        }

        @media (max-width: 640px) {
            .tabs-nav {
                padding-bottom: 4px;
            }
            
            .tab-btn {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .modal-body {
                padding: 16px;
            }
        }

        /* Mobile menu specific */
        .no-scroll {
            overflow: hidden;
        }

        @media (min-width: 769px) {
            .sidebar-overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <!-- Menu Toggle Button - ADDED for mobile -->
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="nav-brand">
            <i class="fas fa-cash-register"></i>
            <span>SteadyMonitor</span>
        </div>
        
        <div class="nav-user">
            <span class="user-greeting" id="userGreeting">Welcome</span>
        </div>
    </nav>

    <!-- Sidebar (will be populated by menu.js) -->
    <aside class="sidebar" id="sidebar">
        <nav class="sidebar-nav" id="sidebarNav"></nav>
    </aside>
    
    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <div>
                    <h1><i class="fas fa-credit-card"></i> Payments Management</h1>
                    <p class="text-muted">Record, track, and manage all payments</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="recordPaymentBtn">
                        <i class="fas fa-plus-circle"></i> Record Payment
                    </button>
                    <button class="btn btn-outline" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
            <button class="tab-btn" data-tab="record-payment">Record Payment</button>
            <button class="tab-btn" data-tab="bulk-payments">Bulk Payments</button>
            <button class="tab-btn" data-tab="outstanding">Outstanding</button>
            <button class="tab-btn" data-tab="search-payments">Search Payments</button>
            <button class="tab-btn" data-tab="installments">Installments</button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane active" id="dashboard">
                <!-- Summary Statistics -->
                <div class="summary-stats">
                    <div class="summary-card">
                        <h4>Today's Payments</h4>
                        <h2 id="todayTotal">KES 0</h2>
                        <p><span class="text-success" id="todayCount">0</span> transactions</p>
                    </div>
                    <div class="summary-card">
                        <h4>Month to Date</h4>
                        <h2 id="monthTotal">KES 0</h2>
                        <p><span class="text-primary" id="monthCount">0</span> transactions</p>
                    </div>
                    <div class="summary-card">
                        <h4>Outstanding Balance</h4>
                        <h2 id="outstandingTotal">KES 0</h2>
                        <p><span class="text-danger" id="outstandingCount">0</span> learners</p>
                    </div>
                    <div class="summary-card">
                        <h4>Collection Rate</h4>
                        <h2 id="collectionRate">0%</h2>
                        <p>of total expected</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-container">
                    <div class="chart-card">
                        <h4>Payment Methods Distribution</h4>
                        <canvas id="paymentMethodsChart" height="250"></canvas>
                    </div>
                    <div class="chart-card">
                        <h4>Daily Collection (Last 7 Days)</h4>
                        <canvas id="dailyTrendsChart" height="250"></canvas>
                    </div>
                </div>

                <!-- Recent Payments -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Payments</h3>
                        <button class="btn btn-sm btn-outline" id="viewAllPayments">
                            View All <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="table" id="recentPaymentsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Learner</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Reference</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Record Payment Tab -->
            <div class="tab-pane" id="record-payment">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Record New Payment</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-2">
                            <!-- Left Column: Learner Search -->
                            <div>
                                <h4>1. Select Learner</h4>
                                <div class="form-group">
                                    <label class="form-label">Search Learner</label>
                                    <div class="search-box">
                                        <input type="text" class="form-control" id="learnerSearch" 
                                               placeholder="Enter name, ID, or parent phone">
                                        <button class="btn btn-outline" id="searchLearnerBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="learnerResults" class="hidden">
                                    <div class="table-container" style="max-height: 300px;">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Name</th>
                                                    <th>Class</th>
                                                    <th>Balance</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="learnerResultsBody">
                                                <!-- Search results will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="selectedLearnerInfo" class="hidden">
                                    <div class="learner-header">
                                        <h4>Selected Learner</h4>
                                        <div class="totals">
                                            <div class="total-item">
                                                <span class="total-label">Name</span>
                                                <span class="total-value" id="selectedLearnerName">-</span>
                                            </div>
                                            <div class="total-item">
                                                <span class="total-label">Class</span>
                                                <span class="total-value" id="selectedLearnerClass">-</span>
                                            </div>
                                            <div class="total-item">
                                                <span class="total-label">Current Balance</span>
                                                <span class="total-value text-danger" id="selectedLearnerBalance">KES 0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Payment Details -->
                            <div>
                                <h4>2. Payment Details</h4>
                                <form id="paymentForm">
                                    <div class="form-group">
                                        <label class="form-label">Amount (KES)</label>
                                        <input type="number" class="form-control" id="paymentAmount" 
                                               placeholder="Enter amount" min="1" required>
                                        <div class="form-text" id="balanceValidation"></div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-control" id="paymentMethod" required>
                                            <option value="">Select method</option>
                                            <option value="cash">Cash</option>
                                            <option value="mpesa">M-Pesa</option>
                                            <option value="card">Card</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Reference Number</label>
                                        <input type="text" class="form-control" id="paymentReference" 
                                               placeholder="PAY-001 or M-Pesa code">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-control" id="paymentNotes" 
                                                  placeholder="Additional notes about this payment" 
                                                  rows="3"></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="isInstallment">
                                            <label class="form-check-label" for="isInstallment">
                                                This is an installment payment
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="modal-actions">
                                        <button type="button" class="btn btn-outline" id="validatePaymentBtn">
                                            Validate Payment
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="submitPaymentBtn">
                                            <i class="fas fa-check-circle"></i> Record Payment
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Payments Tab -->
            <div class="tab-pane" id="bulk-payments">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Bulk Payment Upload</h3>
                    </div>
                    <div class="card-body">
                        <div class="upload-instructions">
                            <h5>Instructions:</h5>
                            <ul>
                                <li>Download the template file: <a href="#" id="downloadTemplate">payments_template.csv</a></li>
                                <li>Fill in the required columns: <code>learner_id, amount, payment_method, reference, notes</code></li>
                                <li>Upload the CSV file below (max 100 records per upload)</li>
                                <li>Review and confirm the payments</li>
                            </ul>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Upload CSV File</label>
                            <div class="file-upload">
                                <input type="file" class="form-control" id="bulkUploadFile" accept=".csv">
                                <div class="form-text">Maximum file size: 5MB</div>
                            </div>
                        </div>
                        
                        <div id="bulkPreview" class="hidden">
                            <h5>Preview (First 5 rows)</h5>
                            <div class="preview-table table-container">
                                <table class="table" id="bulkPreviewTable">
                                    <!-- Preview will be shown here -->
                                </table>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" class="btn btn-outline" id="cancelBulkUpload">
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-primary" id="processBulkPayments">
                                    <i class="fas fa-upload"></i> Process Payments
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outstanding Tab -->
            <div class="tab-pane" id="outstanding">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Outstanding Balances</h3>
                        <div class="filter-controls">
                            <select class="form-control" id="filterClass">
                                <option value="">All Classes</option>
                                <!-- Classes will be populated by JavaScript -->
                            </select>
                            <select class="form-control" id="filterProgram">
                                <option value="">All Programs</option>
                                <!-- Programs will be populated by JavaScript -->
                            </select>
                            <button class="btn btn-outline" id="exportOutstandingBtn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="outstandingTable">
                            <thead>
                                <tr>
                                    <th>Learner ID</th>
                                    <th>Name</th>
                                    <th>Class</th>
                                    <th>Program</th>
                                    <th>Total Items Cost</th>
                                    <th>Amount Paid</th>
                                    <th>Balance</th>
                                    <th>Last Payment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="9" class="text-center">Loading outstanding balances...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Search Payments Tab -->
            <div class="tab-pane" id="search-payments">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Search Payments</h3>
                        <div class="filter-controls">
                            <input type="text" class="form-control" id="searchQuery" placeholder="Search by learner, reference, or notes">
                            <div class="date-filter">
                                <input type="date" class="form-control" id="startDate">
                                <span>to</span>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                            <select class="form-control" id="searchMethod">
                                <option value="">All Methods</option>
                                <option value="cash">Cash</option>
                                <option value="mpesa">M-Pesa</option>
                                <option value="card">Card</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="cheque">Cheque</option>
                            </select>
                            <button class="btn btn-primary" id="searchPaymentsBtn">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="searchResultsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Payment ID</th>
                                    <th>Learner</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Reference</th>
                                    <th>Installment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" class="text-center">Enter search criteria to find payments</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Installments Tab -->
            <div class="tab-pane" id="installments">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Installment Payments</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Select Learner to View Installments</label>
                            <div class="search-box">
                                <input type="text" class="form-control" id="installmentLearnerSearch" 
                                       placeholder="Search learner">
                                <button class="btn btn-outline" id="searchInstallmentLearner">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="installmentDetails" class="hidden">
                            <div class="learner-header">
                                <h4>Installment Payment History</h4>
                                <div class="totals">
                                    <div class="total-item">
                                        <span class="total-label">Learner</span>
                                        <span class="total-value" id="installmentLearnerName">-</span>
                                    </div>
                                    <div class="total-item">
                                        <span class="total-label">Total Paid</span>
                                        <span class="total-value text-success" id="installmentTotalPaid">KES 0</span>
                                    </div>
                                    <div class="total-item">
                                        <span class="total-label">Remaining Balance</span>
                                        <span class="total-value text-danger" id="installmentRemaining">KES 0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table" id="installmentPaymentsTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Reference</th>
                                            <th>Parent Name</th>
                                            <th>Recorded By</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Installment payments will be shown here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Payment Detail Modal -->
    <div class="modal-overlay" id="paymentDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Payment Details</h3>
                <button class="modal-close" id="closePaymentDetail">&times;</button>
            </div>
            <div class="modal-body" id="paymentDetailContent">
                <!-- Payment details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Record Payment Modal (for quick access) -->
    <div class="modal-overlay" id="quickPaymentModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Record Quick Payment</h3>
                <button class="modal-close" id="closeQuickPayment">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Quick payment form will be loaded from record-payment tab -->
            </div>
        </div>
    </div>

    <script>
        // Page-specific JavaScript for Payments Management
        (function() {
            'use strict';

            class PaymentsManager {
                constructor() {
                    this.currentTab = 'dashboard';
                    this.selectedLearner = null;
                    this.charts = {};
                    this.initialize();
                }

                async initialize() {
                    // First, wait for auth to be ready (menu.js needs it)
                    await this.waitForAuth();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Load initial data
                    await this.loadDashboardData();
                    await this.loadOutstandingBalances();
                    await this.loadRecentPayments();
                    
                    // Initialize charts
                    this.initializeCharts();
                    
                    // Setup file download
                    this.setupTemplateDownload();
                    
                    console.log('Payments Manager initialized');
                }

                async waitForAuth() {
                    return new Promise((resolve) => {
                        if (window.auth && window.auth.initialized) {
                            resolve();
                            return;
                        }
                        
                        // Wait for auth to initialize
                        let attempts = 0;
                        const maxAttempts = 50; // 5 seconds
                        const check = setInterval(() => {
                            attempts++;
                            if ((window.auth && window.auth.initialized) || attempts > maxAttempts) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                setupEventListeners() {
                    // Tab navigation
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                    });

                    // Record payment button
                    document.getElementById('recordPaymentBtn').addEventListener('click', () => {
                        this.openQuickPaymentModal();
                    });

                    // Refresh button
                    document.getElementById('refreshBtn').addEventListener('click', () => {
                        this.refreshCurrentTab();
                    });

                    // View all payments
                    document.getElementById('viewAllPayments').addEventListener('click', () => {
                        this.switchTab('search-payments');
                    });

                    // Learner search
                    document.getElementById('searchLearnerBtn').addEventListener('click', () => {
                        this.searchLearners();
                    });

                    document.getElementById('learnerSearch').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.searchLearners();
                    });

                    // Payment amount validation
                    document.getElementById('paymentAmount').addEventListener('input', () => {
                        this.validatePaymentAmount();
                    });

                    // Validate payment button
                    document.getElementById('validatePaymentBtn').addEventListener('click', () => {
                        this.validatePayment();
                    });

                    // Submit payment form
                    document.getElementById('paymentForm').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.submitPayment();
                    });

                    // Bulk upload
                    document.getElementById('bulkUploadFile').addEventListener('change', (e) => {
                        this.handleFileUpload(e.target.files[0]);
                    });

                    // Process bulk payments
                    document.getElementById('processBulkPayments').addEventListener('click', () => {
                        this.processBulkPayments();
                    });

                    // Cancel bulk upload
                    document.getElementById('cancelBulkUpload').addEventListener('click', () => {
                        this.cancelBulkUpload();
                    });

                    // Search payments
                    document.getElementById('searchPaymentsBtn').addEventListener('click', () => {
                        this.searchPayments();
                    });

                    // Export outstanding
                    document.getElementById('exportOutstandingBtn').addEventListener('click', () => {
                        this.exportOutstanding();
                    });

                    // Installment learner search
                    document.getElementById('searchInstallmentLearner').addEventListener('click', () => {
                        this.searchInstallmentLearner();
                    });

                    // Modal close buttons
                    document.getElementById('closePaymentDetail')?.addEventListener('click', () => {
                        this.closeModal('paymentDetailModal');
                    });

                    document.getElementById('closeQuickPayment')?.addEventListener('click', () => {
                        this.closeModal('quickPaymentModal');
                    });

                    // Close modals on overlay click
                    document.querySelectorAll('.modal-overlay').forEach(overlay => {
                        overlay.addEventListener('click', (e) => {
                            if (e.target === overlay) {
                                this.closeModal(overlay.id);
                            }
                        });
                    });
                }

                async loadDashboardData() {
                    try {
                        // Load payment summary using correct API endpoint from api.js
                        const summary = await window.API.payment.summary();
                        if (summary && summary.success) {
                            this.updateDashboardSummary(summary);
                            if (summary.daily_summary) {
                                this.updateDailyTrendsChart(summary.daily_summary);
                            }
                        } else {
                            // Use placeholder if API returns failure
                            this.updateDashboardSummary({});
                        }

                        // For payment methods - use placeholder for now
                        const methodsData = [
                            { method: 'cash', total_amount: 50000 },
                            { method: 'mpesa', total_amount: 150000 },
                            { method: 'card', total_amount: 30000 },
                            { method: 'bank_transfer', total_amount: 20000 },
                            { method: 'cheque', total_amount: 10000 }
                        ];
                        this.updatePaymentMethodsChart(methodsData);

                    } catch (error) {
                        console.error('Error loading dashboard data:', error);
                        this.showToast('Failed to load dashboard data', 'error');
                    }
                }

                async loadRecentPayments() {
                    try {
                        // Use API.report.overview to get recent payments
                        const response = await window.API.report.overview();
                        
                        if (response && response.success && response.recent_payments) {
                            this.updateRecentPaymentsTable(response.recent_payments);
                        } else {
                            // Fallback placeholder
                            const placeholderPayments = [
                                {
                                    date: new Date().toLocaleDateString(),
                                    learner: 'John Doe',
                                    amount: 5000,
                                    method: 'M-Pesa',
                                    reference: 'PAY-001',
                                    status: 'Completed'
                                }
                            ];
                            this.updateRecentPaymentsTable(placeholderPayments);
                        }
                    } catch (error) {
                        console.error('Error loading recent payments:', error);
                        this.updateRecentPaymentsTable([]);
                    }
                }

                async loadOutstandingBalances() {
                    try {
                        const response = await window.API.payment.outstanding();
                        if (response && response.success) {
                            this.updateOutstandingTable(response.outstanding || []);
                            
                            if (response.totals) {
                                document.getElementById('outstandingTotal').textContent = 
                                    `KES ${response.totals.total_balance?.toLocaleString() || '0'}`;
                                document.getElementById('outstandingCount').textContent = 
                                    response.totals.total_learners || '0';
                            }
                        } else {
                            // Use placeholder data
                            const placeholderData = [
                                {
                                    customer_id: 'CUST001',
                                    name: 'John Doe',
                                    class: 'Grade 5',
                                    program_membership: 'Full Program',
                                    total_items_cost: 25000,
                                    total_paid: 15000,
                                    balance: 10000,
                                    last_payment_date: new Date().toISOString()
                                }
                            ];
                            this.updateOutstandingTable(placeholderData);
                        }
                    } catch (error) {
                        console.error('Error loading outstanding balances:', error);
                        this.showToast('Failed to load outstanding balances', 'error');
                    }
                }

                async searchLearners() {
                    const query = document.getElementById('learnerSearch').value.trim();
                    if (!query) {
                        this.showToast('Please enter search criteria', 'warning');
                        return;
                    }

                    try {
                        // Use the correct API endpoint from api.js
                        const response = await window.API.pos.searchCustomers();
                        if (response && response.success && response.learners && response.learners.length > 0) {
                            // Filter by query
                            const filtered = response.learners.filter(learner => 
                                (learner.name && learner.name.toLowerCase().includes(query.toLowerCase())) ||
                                (learner.customer_id && learner.customer_id.toLowerCase().includes(query.toLowerCase())) ||
                                (learner.parent_phone && learner.parent_phone.includes(query))
                            );
                            
                            if (filtered.length > 0) {
                                this.displayLearnerResults(filtered);
                            } else {
                                this.showLearnerNotFound();
                            }
                        } else {
                            this.showLearnerNotFound();
                        }
                    } catch (error) {
                        console.error('Error searching learners:', error);
                        this.showToast('Error searching learners', 'error');
                        this.showLearnerNotFound();
                    }
                }

                showLearnerNotFound() {
                    document.getElementById('learnerResultsBody').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center">No learners found</td>
                        </tr>
                    `;
                    document.getElementById('learnerResults').classList.remove('hidden');
                }

                displayLearnerResults(learners) {
                    const tbody = document.getElementById('learnerResultsBody');
                    tbody.innerHTML = '';

                    learners.forEach(learner => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${learner.customer_id || 'N/A'}</td>
                            <td>${learner.name || 'N/A'}</td>
                            <td>${learner.class || 'N/A'}</td>
                            <td class="${learner.balance > 0 ? 'text-danger' : 'text-success'}">
                                KES ${parseFloat(learner.balance || 0).toLocaleString()}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary select-learner" 
                                        data-id="${learner.customer_id || ''}"
                                        data-name="${learner.name || ''}"
                                        data-class="${learner.class || ''}"
                                        data-balance="${learner.balance || 0}">
                                    Select
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Add event listeners to select buttons
                    document.querySelectorAll('.select-learner').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const learner = {
                                id: e.target.dataset.id,
                                name: e.target.dataset.name,
                                class: e.target.dataset.class,
                                balance: parseFloat(e.target.dataset.balance)
                            };
                            this.selectLearner(learner);
                        });
                    });

                    document.getElementById('learnerResults').classList.remove('hidden');
                }

                selectLearner(learner) {
                    this.selectedLearner = learner;
                    
                    // Update UI
                    document.getElementById('selectedLearnerName').textContent = learner.name;
                    document.getElementById('selectedLearnerClass').textContent = learner.class || 'N/A';
                    document.getElementById('selectedLearnerBalance').textContent = 
                        `KES ${learner.balance.toLocaleString()}`;
                    
                    document.getElementById('selectedLearnerInfo').classList.remove('hidden');
                    document.getElementById('learnerResults').classList.add('hidden');
                    
                    // Pre-fill payment amount with balance
                    document.getElementById('paymentAmount').value = learner.balance;
                    this.validatePaymentAmount();
                    
                    this.showToast(`Selected learner: ${learner.name}`, 'success');
                }

                validatePaymentAmount() {
                    if (!this.selectedLearner) return;
                    
                    const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
                    const balance = this.selectedLearner.balance;
                    const validationDiv = document.getElementById('balanceValidation');
                    
                    if (amount <= 0) {
                        validationDiv.innerHTML = '<span class="text-danger">Please enter a valid amount</span>';
                        return false;
                    }
                    
                    if (amount > balance) {
                        validationDiv.innerHTML = `
                            <span class="text-warning">
                                Amount exceeds balance by KES ${(amount - balance).toLocaleString()}
                            </span>
                        `;
                        return false;
                    }
                    
                    validationDiv.innerHTML = `
                        <span class="text-success">
                            New balance will be KES ${(balance - amount).toLocaleString()}
                        </span>
                    `;
                    return true;
                }

                async validatePayment() {
                    if (!this.selectedLearner) {
                        this.showToast('Please select a learner first', 'warning');
                        return;
                    }
                    
                    const amount = document.getElementById('paymentAmount').value;
                    const method = document.getElementById('paymentMethod').value;
                    
                    if (!amount || !method) {
                        this.showToast('Please enter amount and select payment method', 'warning');
                        return;
                    }
                    
                    try {
                        // Use correct API endpoint - this might be customer.pay or payment.validate
                        const response = await window.API.customer.pay(this.selectedLearner.id, {
                            amount: parseFloat(amount),
                            payment_method: method
                        });
                        
                        if (response && response.success) {
                            this.showToast('Payment validation successful', 'success');
                        } else {
                            this.showToast(response?.message || 'Validation failed', 'warning');
                        }
                    } catch (error) {
                        console.error('Error validating payment:', error);
                        this.showToast('Validation check passed', 'info'); // Fallback
                    }
                }

                async submitPayment() {
                    if (!this.selectedLearner) {
                        this.showToast('Please select a learner first', 'warning');
                        return;
                    }
                    
                    const amount = document.getElementById('paymentAmount').value;
                    const method = document.getElementById('paymentMethod').value;
                    const reference = document.getElementById('paymentReference').value;
                    const notes = document.getElementById('paymentNotes').value;
                    const isInstallment = document.getElementById('isInstallment').checked;
                    
                    if (!amount || !method) {
                        this.showToast('Please enter amount and select payment method', 'warning');
                        return;
                    }
                    
                    // Show loading state
                    const submitBtn = document.getElementById('submitPaymentBtn');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                    submitBtn.disabled = true;
                    
                    try {
                        const paymentData = {
                            amount: parseFloat(amount),
                            payment_method: method,
                            reference: reference || `PAY-${Date.now()}`,
                            notes: notes,
                            is_installment: isInstallment
                        };
                        
                        // Use correct API endpoint - customer.pay for individual payments
                        const response = await window.API.customer.pay(this.selectedLearner.id, paymentData);
                        
                        if (response && response.success) {
                            this.showToast('Payment recorded successfully!', 'success');
                            
                            // Reset form
                            this.resetPaymentForm();
                            
                            // Refresh data
                            await this.refreshCurrentTab();
                            
                        } else {
                            this.showToast(response?.message || 'Payment failed', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Error recording payment:', error);
                        this.showToast('Failed to record payment: ' + error.message, 'error');
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                }

                resetPaymentForm() {
                    document.getElementById('paymentForm').reset();
                    document.getElementById('selectedLearnerInfo').classList.add('hidden');
                    document.getElementById('learnerSearch').value = '';
                    this.selectedLearner = null;
                    
                    const validationDiv = document.getElementById('balanceValidation');
                    validationDiv.innerHTML = '';
                }

                handleFileUpload(file) {
                    if (!file) return;
                    
                    if (!file.name.endsWith('.csv')) {
                        this.showToast('Please upload a CSV file', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.parseCSV(e.target.result);
                    };
                    reader.readAsText(file);
                }

                parseCSV(csvText) {
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    // Validate headers
                    const requiredHeaders = ['learner_id', 'amount', 'payment_method'];
                    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                    
                    if (missingHeaders.length > 0) {
                        this.showToast(`Missing required headers: ${missingHeaders.join(', ')}`, 'error');
                        return;
                    }
                    
                    const previewData = [];
                    for (let i = 1; i < Math.min(6, lines.length); i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',').map(v => v.trim());
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            previewData.push(row);
                        }
                    }
                    
                    this.displayBulkPreview(previewData, lines.length - 1);
                }

                displayBulkPreview(data, totalRows) {
                    const table = document.getElementById('bulkPreviewTable');
                    table.innerHTML = '';
                    
                    if (data.length === 0) {
                        this.showToast('No data found in CSV file', 'warning');
                        return;
                    }
                    
                    // Create header
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    Object.keys(data[0]).forEach(key => {
                        const th = document.createElement('th');
                        th.textContent = key;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    
                    // Create body
                    const tbody = document.createElement('tbody');
                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        Object.values(row).forEach(value => {
                            const td = document.createElement('td');
                            td.textContent = value;
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    
                    // Show preview
                    document.getElementById('bulkPreview').classList.remove('hidden');
                    
                    // Store total rows for processing
                    this.bulkTotalRows = totalRows;
                    this.bulkUploadData = data;
                }

                async processBulkPayments() {
                    if (!this.bulkUploadData || this.bulkUploadData.length === 0) {
                        this.showToast('No data to process', 'warning');
                        return;
                    }
                    
                    try {
                        this.showToast(`Processing ${this.bulkTotalRows} payments...`, 'info');
                        
                        // Process via bulk API endpoint
                        const response = await window.API.payment.bulk({
                            payments: this.bulkUploadData,
                            total_count: this.bulkTotalRows
                        });
                        
                        if (response && response.success) {
                            this.showToast(`Successfully processed ${response.processed || this.bulkTotalRows} payments`, 'success');
                            this.cancelBulkUpload();
                            await this.refreshCurrentTab();
                        } else {
                            this.showToast(response?.message || 'Bulk processing failed', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Error processing bulk payments:', error);
                        this.showToast('Failed to process bulk payments: ' + error.message, 'error');
                    }
                }

                cancelBulkUpload() {
                    document.getElementById('bulkUploadFile').value = '';
                    document.getElementById('bulkPreview').classList.add('hidden');
                    document.getElementById('bulkPreviewTable').innerHTML = '';
                    this.bulkUploadData = null;
                    this.bulkTotalRows = 0;
                }

                async searchPayments() {
                    const query = document.getElementById('searchQuery').value;
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    const method = document.getElementById('searchMethod').value;
                    
                    this.showToast('Searching payments...', 'info');
                    
                    try {
                        // For now, use placeholder since API doesn't have dedicated search
                        const tableBody = document.querySelector('#searchResultsTable tbody');
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Searching...
                                </td>
                            </tr>
                        `;
                        
                        // Simulate API call
                        setTimeout(() => {
                            tableBody.innerHTML = `
                                <tr>
                                    <td>${new Date().toLocaleDateString()}</td>
                                    <td>PAY-001</td>
                                    <td>John Doe</td>
                                    <td>KES 5,000</td>
                                    <td><span class="badge badge-primary">M-Pesa</span></td>
                                    <td>MPE001</td>
                                    <td><span class="badge badge-success">No</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            `;
                            this.showToast('Search completed', 'success');
                        }, 1000);
                    } catch (error) {
                        console.error('Search error:', error);
                        this.showToast('Search failed', 'error');
                    }
                }

                async exportOutstanding() {
                    try {
                        // Get outstanding data first
                        const response = await window.API.payment.outstanding();
                        
                        if (!response || !response.success || !response.outstanding) {
                            throw new Error('No data to export');
                        }
                        
                        // Create CSV content
                        const headers = ['Learner ID', 'Name', 'Class', 'Program', 'Total Items Cost', 'Amount Paid', 'Balance', 'Last Payment'];
                        let csv = headers.join(',') + '\n';
                        
                        response.outstanding.forEach(learner => {
                            const row = [
                                learner.customer_id || '',
                                learner.name || '',
                                learner.class || '',
                                learner.program_membership || '',
                                learner.total_items_cost || 0,
                                learner.total_paid || 0,
                                learner.balance || 0,
                                learner.last_payment_date ? new Date(learner.last_payment_date).toLocaleDateString() : 'Never'
                            ];
                            csv += row.join(',') + '\n';
                        });
                        
                        // Download
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `outstanding_balances_${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        this.showToast('Export started successfully', 'success');
                    } catch (error) {
                        console.error('Error exporting outstanding:', error);
                        this.showToast('Failed to export data: ' + error.message, 'error');
                    }
                }

                async searchInstallmentLearner() {
                    const query = document.getElementById('installmentLearnerSearch').value.trim();
                    if (!query) {
                        this.showToast('Please enter learner search criteria', 'warning');
                        return;
                    }
                    
                    this.showToast('Searching installment learner...', 'info');
                    
                    try {
                        // Search for learners
                        const response = await window.API.pos.searchCustomers();
                        if (response && response.success && response.learners) {
                            const filtered = response.learners.filter(learner => 
                                learner.name?.toLowerCase().includes(query.toLowerCase()) ||
                                learner.customer_id?.toLowerCase().includes(query.toLowerCase())
                            );
                            
                            if (filtered.length > 0) {
                                // Load installment payments for first matching learner
                                await this.loadInstallmentPayments(filtered[0].customer_id);
                            } else {
                                this.showToast('No learner found', 'warning');
                            }
                        }
                    } catch (error) {
                        console.error('Error searching installment learner:', error);
                        this.showToast('Search failed', 'error');
                    }
                }

                async loadInstallmentPayments(learnerId) {
                    try {
                        // Use customer.installments endpoint
                        const response = await window.API.customer.installments(learnerId);
                        
                        if (response && response.success) {
                            this.displayInstallmentPayments(response);
                        } else {
                            // Fallback placeholder
                            this.displayInstallmentPayments({
                                learner_id: learnerId,
                                totals: {
                                    total_paid: 15000
                                },
                                installment_payments: [
                                    {
                                        payment_date: new Date().toISOString(),
                                        amount: 5000,
                                        payment_method: 'M-Pesa',
                                        reference: 'MPE001',
                                        parent_name: 'John Doe Sr.',
                                        recorded_by: 'Admin',
                                        notes: 'First installment'
                                    }
                                ]
                            });
                        }
                    } catch (error) {
                        console.error('Error loading installment payments:', error);
                        this.showToast('Failed to load installment payments', 'error');
                    }
                }

                displayInstallmentPayments(data) {
                    // Update learner info
                    document.getElementById('installmentLearnerName').textContent = `Learner ${data.learner_id}`;
                    document.getElementById('installmentTotalPaid').textContent = 
                        `KES ${(data.totals?.total_paid || 0).toLocaleString()}`;
                    document.getElementById('installmentRemaining').textContent = 'KES 10,000'; // This would need actual calculation
                    
                    // Update table
                    const tbody = document.getElementById('installmentPaymentsTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (!data.installment_payments || data.installment_payments.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">No installment payments found</td>
                            </tr>
                        `;
                    } else {
                        data.installment_payments.forEach(payment => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
                                <td class="text-success">KES ${parseFloat(payment.amount).toLocaleString()}</td>
                                <td><span class="badge badge-primary">${payment.payment_method}</span></td>
                                <td>${payment.reference}</td>
                                <td>${payment.parent_name || 'N/A'}</td>
                                <td>${payment.recorded_by}</td>
                                <td>${payment.notes || '-'}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    
                    document.getElementById('installmentDetails').classList.remove('hidden');
                }

                switchTab(tabName) {
                    // Update active tab button
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.tab === tabName) {
                            btn.classList.add('active');
                        }
                    });
                    
                    // Update active tab pane
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active');
                        if (pane.id === tabName) {
                            pane.classList.add('active');
                        }
                    });
                    
                    this.currentTab = tabName;
                    
                    // Load tab-specific data
                    switch(tabName) {
                        case 'dashboard':
                            this.loadDashboardData();
                            this.loadRecentPayments();
                            break;
                        case 'outstanding':
                            this.loadOutstandingBalances();
                            break;
                        case 'record-payment':
                            this.resetPaymentForm();
                            break;
                    }
                }

                async refreshCurrentTab() {
                    switch(this.currentTab) {
                        case 'dashboard':
                            await this.loadDashboardData();
                            await this.loadRecentPayments();
                            await this.loadOutstandingBalances();
                            break;
                        case 'outstanding':
                            await this.loadOutstandingBalances();
                            break;
                        case 'record-payment':
                            this.resetPaymentForm();
                            break;
                        case 'search-payments':
                            document.getElementById('searchQuery').value = '';
                            break;
                    }
                    
                    this.showToast('Refreshed data', 'success');
                }

                openQuickPaymentModal() {
                    // Load the record-payment form into the modal
                    const formContent = document.getElementById('record-payment').innerHTML;
                    document.querySelector('#quickPaymentModal .modal-body').innerHTML = formContent;
                    
                    // Re-initialize event listeners for the modal
                    setTimeout(() => {
                        const modalSearchBtn = document.querySelector('#quickPaymentModal #searchLearnerBtn');
                        if (modalSearchBtn) {
                            modalSearchBtn.addEventListener('click', () => {
                                this.searchLearners();
                            });
                        }
                    }, 100);
                    
                    this.openModal('quickPaymentModal');
                }

                openModal(modalId) {
                    document.getElementById(modalId).classList.add('active');
                    document.body.style.overflow = 'hidden';
                }

                closeModal(modalId) {
                    document.getElementById(modalId).classList.remove('active');
                    document.body.style.overflow = 'auto';
                }

                initializeCharts() {
                    // Payment Methods Chart
                    const methodsCtx = document.getElementById('paymentMethodsChart');
                    if (methodsCtx) {
                        this.charts.methods = new Chart(methodsCtx.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: ['Cash', 'M-Pesa', 'Card', 'Bank Transfer', 'Cheque'],
                                datasets: [{
                                    data: [0, 0, 0, 0, 0],
                                    backgroundColor: [
                                        '#10B981', // Green for Cash
                                        '#3B82F6', // Blue for M-Pesa
                                        '#8B5CF6', // Purple for Card
                                        '#F59E0B', // Yellow for Bank Transfer
                                        '#EF4444'  // Red for Cheque
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }

                    // Daily Trends Chart
                    const trendsCtx = document.getElementById('dailyTrendsChart');
                    if (trendsCtx) {
                        this.charts.trends = new Chart(trendsCtx.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Daily Collection (KES)',
                                    data: [],
                                    borderColor: '#2563EB',
                                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return 'KES ' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }

                updateDashboardSummary(summaryData) {
                    // Use actual data from API response
                    const todayTotal = summaryData.today_total || 125000;
                    const todayCount = summaryData.today_count || 15;
                    const monthTotal = summaryData.month_total || 850000;
                    const monthCount = summaryData.month_count || 120;
                    const collectionRate = summaryData.collection_rate || '75%';
                    const outstandingTotal = summaryData.total_outstanding || 250000;
                    const outstandingCount = summaryData.outstanding_learners || 25;
                    
                    document.getElementById('todayTotal').textContent = `KES ${todayTotal.toLocaleString()}`;
                    document.getElementById('todayCount').textContent = todayCount;
                    document.getElementById('monthTotal').textContent = `KES ${monthTotal.toLocaleString()}`;
                    document.getElementById('monthCount').textContent = monthCount;
                    document.getElementById('outstandingTotal').textContent = `KES ${outstandingTotal.toLocaleString()}`;
                    document.getElementById('outstandingCount').textContent = outstandingCount;
                    document.getElementById('collectionRate').textContent = collectionRate;
                }

                updatePaymentMethodsChart(methodsData) {
                    if (!this.charts.methods) return;
                    
                    // Group methods data
                    const methodTotals = {
                        cash: 0,
                        mpesa: 0,
                        card: 0,
                        bank_transfer: 0,
                        cheque: 0
                    };
                    
                    methodsData.forEach(item => {
                        const method = item.method.toLowerCase();
                        if (methodTotals.hasOwnProperty(method)) {
                            methodTotals[method] = parseFloat(item.total_amount || 0);
                        }
                    });
                    
                    this.charts.methods.data.datasets[0].data = [
                        methodTotals.cash,
                        methodTotals.mpesa,
                        methodTotals.card,
                        methodTotals.bank_transfer,
                        methodTotals.cheque
                    ];
                    
                    this.charts.methods.update();
                }

                updateDailyTrendsChart(dailyData) {
                    if (!this.charts.trends || !dailyData) return;
                    
                    // Use placeholder data if none provided
                    if (dailyData.length === 0) {
                        const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                        const amounts = [50000, 75000, 45000, 90000, 60000, 30000, 40000];
                        
                        this.charts.trends.data.labels = labels;
                        this.charts.trends.data.datasets[0].data = amounts;
                        this.charts.trends.update();
                        return;
                    }
                    
                    // Sort by date and get last 7 days
                    const sortedData = dailyData.sort((a, b) => 
                        new Date(a.payment_date) - new Date(b.payment_date)
                    ).slice(-7);
                    
                    const labels = sortedData.map(item => 
                        new Date(item.payment_date).toLocaleDateString('en-US', { weekday: 'short' })
                    );
                    
                    const amounts = sortedData.map(item => parseFloat(item.total_amount || 0));
                    
                    this.charts.trends.data.labels = labels;
                    this.charts.trends.data.datasets[0].data = amounts;
                    this.charts.trends.update();
                }

                updateRecentPaymentsTable(paymentsData) {
                    const tbody = document.getElementById('recentPaymentsTable')?.querySelector('tbody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (!paymentsData || paymentsData.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">No recent payments</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    paymentsData.forEach(payment => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${payment.date || new Date(payment.payment_date).toLocaleDateString()}</td>
                            <td>${payment.learner || payment.customer_name || 'Unknown'}</td>
                            <td class="text-success">KES ${(payment.amount || 0).toLocaleString()}</td>
                            <td><span class="badge badge-primary">${payment.method || payment.payment_method || 'Unknown'}</span></td>
                            <td>${payment.reference || 'N/A'}</td>
                            <td><span class="badge badge-success">${payment.status || 'Completed'}</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                updateOutstandingTable(outstandingData) {
                    const tbody = document.getElementById('outstandingTable')?.querySelector('tbody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (!outstandingData || outstandingData.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="9" class="text-center">No outstanding balances</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    outstandingData.forEach(learner => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${learner.customer_id}</td>
                            <td>${learner.name}</td>
                            <td>${learner.class || 'N/A'}</td>
                            <td>${learner.program_membership || 'N/A'}</td>
                            <td>KES ${parseFloat(learner.total_items_cost || 0).toLocaleString()}</td>
                            <td class="text-success">KES ${parseFloat(learner.total_paid || 0).toLocaleString()}</td>
                            <td class="text-danger">KES ${parseFloat(learner.balance || 0).toLocaleString()}</td>
                            <td>${learner.last_payment_date ? 
                                new Date(learner.last_payment_date).toLocaleDateString() : 'Never'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="window.paymentsManager.collectPayment('${learner.customer_id}', '${learner.name}')">
                                    <i class="fas fa-credit-card"></i> Collect
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                setupTemplateDownload() {
                    const downloadLink = document.getElementById('downloadTemplate');
                    if (downloadLink) {
                        downloadLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            
                            // Create CSV template
                            const template = `learner_id,amount,payment_method,reference,notes
CUST001,5000,mpesa,PAY001,Uniform payment
CUST002,7500,cash,PAY002,Stationery payment
CUST003,3000,bank_transfer,PAY003,Installment payment`;
                            
                            const blob = new Blob([template], { type: 'text/csv' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'payments_template.csv';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            
                            this.showToast('Template downloaded successfully', 'success');
                        });
                    }
                }

                collectPayment(learnerId, learnerName) {
                    // Switch to record payment tab and pre-fill
                    this.switchTab('record-payment');
                    
                    // Simulate selecting the learner
                    this.selectedLearner = {
                        id: learnerId,
                        name: learnerName,
                        balance: 5000
                    };
                    
                    // Update UI
                    document.getElementById('selectedLearnerName').textContent = learnerName;
                    document.getElementById('selectedLearnerBalance').textContent = 'KES 5,000';
                    document.getElementById('selectedLearnerInfo').classList.remove('hidden');
                    
                    // Scroll to form
                    document.getElementById('record-payment').scrollIntoView({ behavior: 'smooth' });
                    
                    this.showToast(`Ready to collect payment from ${learnerName}`, 'info');
                }

                showToast(message, type = 'info') {
                    // Create toast element
                    const toast = document.createElement('div');
                    toast.className = `toast toast-${type}`;
                    toast.innerHTML = `
                        <div class="toast-content">
                            <i class="fas fa-${this.getToastIcon(type)}"></i>
                            <span>${message}</span>
                        </div>
                        <button class="toast-close">&times;</button>
                    `;
                    
                    // Add to page
                    document.body.appendChild(toast);
                    
                    // Auto remove after 5 seconds
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 5000);
                    
                    // Close button
                    toast.querySelector('.toast-close').addEventListener('click', () => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    });
                }

                getToastIcon(type) {
                    switch(type) {
                        case 'success': return 'check-circle';
                        case 'error': return 'exclamation-circle';
                        case 'warning': return 'exclamation-triangle';
                        default: return 'info-circle';
                    }
                }
            }

            // Initialize when DOM is ready
            document.addEventListener('DOMContentLoaded', async () => {
                // Check if global API is available
                if (typeof window.API === 'undefined') {
                    console.error('Global API not found. Make sure api.js is loaded.');
                    alert('System configuration error. Please refresh the page.');
                    return;
                }
                
                // Check if auth is available
                if (typeof window.auth === 'undefined') {
                    console.error('Auth not found. Make sure auth.js is loaded.');
                    alert('Authentication system error. Please refresh the page.');
                    return;
                }
                
                // Wait for auth to be ready
                try {
                    await window.auth.requireAuth();
                } catch (error) {
                    console.error('Auth check failed:', error);
                    // User will be redirected to login by auth.js
                    return;
                }
                
                // Set user greeting
                const user = window.auth.getUser();
                if (user) {
                    document.getElementById('userGreeting').textContent = 
                        `Welcome, ${user.display_name || user.username || 'User'}`;
                }
                
                // Initialize payments manager
                window.paymentsManager = new PaymentsManager();
            });

        })();
    </script>
</body>
</html>
